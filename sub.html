<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALOS_ | AI Chatbot</title>

<style>
:root {
    --bg: #eef3ff;
    --container-bg: #f7f9ff;
    --panel: #eef2ff;
    --text: #0f172a;
    --user-msg: #2563eb;
    --user-text: #ffffff;
    --bot-msg: #ffffff;
    --border: rgba(15,23,42,0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    background: linear-gradient(180deg, #eef3ff, #ffffff);
    font-family: system-ui, -apple-system, Segoe UI, sans-serif;
    display: flex;
    justify-content: center;
    height: 100vh;
}

.container {
    width: 60%;
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--container-bg);
}

@media (max-width: 768px) { .container { width: 100%; } }

header {
    padding: 14px;
    font-weight: 700;
    text-align: center;
    border-bottom: 1px solid var(--border);
}

#chat-window {
    flex: 1;
    padding: 22px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.message {
    max-width: 75%;
    padding: 14px 16px;
    border-radius: 14px;
    font-size: 0.95rem;
    line-height: 1.7;
    white-space: normal;
}

.user-message {
    align-self: flex-end;
    background: var(--user-msg);
    color: var(--user-text);
}

.bot-message {
    align-self: flex-start;
    background: var(--bot-msg);
    border: 1px solid var(--border);
}

/* Markdown-like formatting */
.bot-message p { margin-bottom: 10px; }

.bot-message ul {
    padding-left: 18px;
    margin: 8px 0;
}

.bot-message li {
    margin-bottom: 6px;
}

.ai-heading {
    color: #facc15;
    font-weight: 700;
    display: block;
    margin: 12px 0 6px;
}

/* Input areas */
.input-container {
    border-top: 1px solid var(--border);
    background: var(--panel);
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

textarea {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    resize: none;
    font-size: 0.9rem;
}

button {
    padding: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
}

.send { background: #2563eb; color: white; }
.stop { background: #ef4444; color: white; }

footer {
    text-align: center;
    font-size: 0.6rem;
    opacity: 0.4;
    padding: 8px;
}
</style>
</head>

<body>

<div class="container">
<header>ALOS_</header>

<div id="chat-window"></div>

<div class="input-container">
    <!-- CUSTOM PROMPT -->
    <textarea id="systemPrompt" rows="2"
      placeholder="Custom system prompt (saved locally)"></textarea>

    <!-- USER INPUT -->
    <textarea id="userInput" rows="2"
      placeholder="Enter message..."></textarea>

    <div style="display:flex; gap:8px;">
        <button class="send" id="sendBtn">Send</button>
        <button class="stop" id="stopBtn">Terminate</button>
    </div>
</div>

<footer>LOCAL STORAGE | GEMINI AI</footer>
</div>

<script>
const API_KEY = "AIzaSyAO0OfW34GELdDk1yjO3HDMFOzaPEQjNoI";
const MODEL = "gemini-2.5-flash";

const chatWindow = document.getElementById("chat-window");
const userInput = document.getElementById("userInput");
const systemPromptInput = document.getElementById("systemPrompt");
const sendBtn = document.getElementById("sendBtn");
const stopBtn = document.getElementById("stopBtn");

let controller = null;

/* ---------- LOCAL STORAGE ---------- */
systemPromptInput.value = localStorage.getItem("systemPrompt") || "";

let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
history.forEach(m => addMessage(m.text, m.role, false));

systemPromptInput.addEventListener("input", () => {
    localStorage.setItem("systemPrompt", systemPromptInput.value);
});

/* ---------- FORMATTING ---------- */
function renderMarkdown(text) {
    text = text.replace(/\*\*(.*?)\*\*/g, '<span class="ai-heading">$1</span>');
    text = text.replace(/^\* (.*)$/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
    text = text.replace(/\n{2,}/g, '</p><p>');
    return `<p>${text}</p>`;
}

/* ---------- UI ---------- */
function addMessage(text, role, save = true) {
    const div = document.createElement("div");
    div.className = `message ${role === "user" ? "user-message" : "bot-message"}`;
    div.innerHTML = role === "user" ? text : renderMarkdown(text);
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    if (save) {
        history.push({ role, text });
        localStorage.setItem("chatHistory", JSON.stringify(history));
    }
    return div;
}

/* ---------- SEND ---------- */
async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    addMessage(text, "user");
    userInput.value = "";

    controller = new AbortController();
    const botBubble = addMessage("...", "bot");

    try {
        const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
            {
                method: "POST",
                signal: controller.signal,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [
                        { role: "user", parts: [{ text: systemPromptInput.value }] },
                        ...history.map(h => ({
                            role: h.role === "user" ? "user" : "model",
                            parts: [{ text: h.text }]
                        }))
                    ]
                })
            }
        );

        const data = await res.json();
        botBubble.innerHTML = renderMarkdown(
            data.candidates[0].content.parts[0].text
        );

    } catch (e) {
        botBubble.innerText = e.name === "AbortError"
            ? "â›” Generation terminated."
            : "Error occurred.";
    }
}

/* ---------- TERMINATE ---------- */
stopBtn.addEventListener("click", () => {
    if (controller) controller.abort();
});

/* ---------- EVENTS ---------- */
sendBtn.addEventListener("click", sendMessage);
userInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>

</body>
</html>
