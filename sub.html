<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALOS | Backend Architect AI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
        /* --- üé® THEME VARIABLES --- */
        :root {
            /* üîπ UPDATED: Mid-Blue Theme */
            --bg-color: #2b5278;       /* The "Mid Blue" you asked for */
            --chat-bg: #3a6b99;        /* Slightly lighter for bubbles */
            --text-color: #ffffff;     /* White text still pops perfectly */
            --accent-yellow: #FFD700;  /* Gold headings */
            --input-bg: #1c3a59;       /* Darker blue for the input bar */
            --user-bubble: #4fa3d1;    /* Lighter blue for user messages */
            --danger-red: #ff4444;     
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- üîπ HEADER --- */
        header {
            text-align: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(43, 82, 120, 0.95); /* Matches new bg-color */
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 10;
        }

        h1.logo {
            font-size: 1.8rem;
            letter-spacing: 2px;
            color: var(--text-color);
            font-weight: 700;
        }

        .cursor { color: var(--accent-yellow); animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- üí¨ CHAT AREA (CENTERED 60%) --- */
        #chat-container {
            flex: 1;
            padding-top: 80px;      /* Header Height */
            padding-bottom: 120px;  /* Input Height */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* The Centered Wrapper */
        .chat-wrapper {
            width: 60%;         /* Requirement A: 60% Width */
            margin: 0 auto;     /* Center it */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Mobile Responsive Override */
        @media (max-width: 768px) {
            .chat-wrapper { width: 95%; }
        }

        /* Messages */
        .message {
            max-width: 100%; 
            padding: 15px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 1rem;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: #ffffff;
            border-bottom-right-radius: 2px;
            width: fit-content; 
            margin-left: auto;
        }

        .ai-message {
            align-self: flex-start;
            background-color: transparent;
            border-left: 3px solid var(--accent-yellow);
            padding-left: 20px;
            width: 100%; 
        }

        /* AI Markdown Styling */
        .ai-message h1, .ai-message h2, .ai-message h3 { color: var(--accent-yellow); margin: 15px 0 10px; font-weight: 600; }
        .ai-message strong { color: var(--accent-yellow); }
        .ai-message code { background: #000; padding: 2px 5px; border-radius: 4px; color: #00ff88; font-family: monospace; }
        .ai-message pre { background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 10px 0; }
        .ai-message ul { margin-left: 20px; }

        /* --- ‚å®Ô∏è INPUT AREA (CENTERED 60%) --- */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-color);
            padding: 20px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: center;
            z-index: 20;
        }

        .input-wrapper {
            width: 60%;         
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: border-color 0.3s;
        }

        @media (max-width: 768px) {
            .input-wrapper { width: 95%; }
        }

        input[type="text"] {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 15px 20px;
            font-size: 1rem;
            outline: none;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            padding-right: 15px;
        }

        button {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            transition: transform 0.2s;
            padding: 5px;
        }
        
        button:hover { transform: scale(1.1); }
        
        #send-btn { color: var(--accent-yellow); }
        
        /* Requirement C: Terminate Button */
        #stop-btn {
            color: var(--danger-red);
            font-size: 1.2rem;
            border: 1px solid var(--danger-red);
            border-radius: 5px;
            padding: 5px 10px;
            display: none; 
        }
        #stop-btn:hover { background: rgba(255, 68, 68, 0.1); }
    </style>
</head>
<body>

    <header>
        <h1 class="logo">ALOS<span class="cursor">_</span></h1>
    </header>

    <main id="chat-container">
        <div class="chat-wrapper" id="chat-content">
            <div class="message ai-message">
                <h2>System Online.</h2>
                <p>I am ALOS. I specialize in backend architecture. Describe your project requirements (Scalability, Budget, Region), and I will architect the solution.</p>
            </div>
        </div>
    </main>

    <footer class="input-area">
        <div class="input-wrapper">
            <input type="text" id="user-input" placeholder="Enter your prompt..." autocomplete="off">
            <div class="btn-group">
                <button id="stop-btn">‚ñ† Stop</button>
                <button id="send-btn">‚û§</button>
            </div>
        </div>
    </footer>
<script>
        // ==========================================
        // üîê SETUP
        // ==========================================
        // TODO: PASTE YOUR REVERSED API KEY BELOW
        const REVERSED_API_KEY = "cWdq0qeuMzqQoyWlXBVh1r6XTwaGTmVQDySazIA"; 

        const SYSTEM_PROMPT = `
        You are ALOS, a senior backend architect AI.
        Your goal: Suggest the best backend tech stack based on user constraints.
        FORMAT RULES:
        1. Use Yellow Headings (Markdown ##) for main sections.
        2. Use bullet points for features.
        3. Be concise and technical.
        `;

        // ==========================================
        // ‚öôÔ∏è STATE MANAGEMENT
        // ==========================================
        const chatContent = document.getElementById('chat-content');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const chatContainer = document.getElementById('chat-container');
        
        let abortController = null; // Controls the "Stop" button
        let chatHistory = JSON.parse(localStorage.getItem('alos_history')) || [];

        // ==========================================
        // üöÄ INITIALIZATION
        // ==========================================
        window.onload = () => { renderHistory(); };

        function getApiKey() { return REVERSED_API_KEY.split('').reverse().join(''); }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        function renderHistory() {
            if(chatHistory.length > 0) {
                chatContent.innerHTML = ''; 
                chatHistory.forEach(msg => {
                    appendMessageToDOM(msg.role, msg.content, false);
                });
            }
        }

        // ‚úÖ ROBUST PARSER: Ensures '##' becomes Yellow Headings even without internet
        function safeMarkdownParse(text) {
            // 1. Try marked.js Library (Best Quality)
            if (typeof marked !== 'undefined') {
                return marked.parse(text);
            }
            
            // 2. Fallback Manual Parser (If library fails)
            let html = text
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>') // Bold
                .replace(/^\* (.*$)/gim, '<br>‚Ä¢ $1') // Bullets
                .replace(/\n/gim, '<br>'); // Newlines
            return html;
        }

        function appendMessageToDOM(role, content, save = true) {
            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
            // Apply parser only to AI messages
            div.innerHTML = role === 'ai' ? safeMarkdownParse(content) : content;
            chatContent.appendChild(div);
            scrollToBottom();
            
            if (save && content.trim() !== "") {
                chatHistory.push({ role: role, content: content });
                localStorage.setItem('alos_history', JSON.stringify(chatHistory));
            }
            return div;
        }

        // ==========================================
        // ‚ö° STREAMING LOGIC (With Formatting Fix)
        // ==========================================
        async function handleSend() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UI Prep
            appendMessageToDOM('user', text);
            userInput.value = '';
            
            // Toggle Buttons
            sendBtn.style.display = 'none';
            stopBtn.style.display = 'block';

            // Create AI Bubble
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'message ai-message';
            aiMessageDiv.innerHTML = '<span class="cursor">|</span>'; 
            chatContent.appendChild(aiMessageDiv);
            scrollToBottom();

            // 2. Prepare Context
            const contents = [
                { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
                ...chatHistory.map(msg => ({
                    role: msg.role === 'ai' ? 'model' : 'user',
                    parts: [{ text: msg.content }]
                })),
                { role: "user", parts: [{ text: text }] }
            ];

            abortController = new AbortController();

            try {
                const apiKey = getApiKey();
                // Using Gemini 2.5 Flash (Free & Fast)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:streamGenerateContent?alt=sse&key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: contents }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = ''; 
                let fullResponseText = ''; 

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.replace('data: ', '').trim();
                            if (jsonStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(jsonStr);
                                const newText = data.candidates[0].content.parts[0].text;
                                if (newText) {
                                    fullResponseText += newText;
                                    // ‚ö° CRITICAL FIX: Re-render FULL text to fix Markdown "##" issues
                                    aiMessageDiv.innerHTML = safeMarkdownParse(fullResponseText);
                                    scrollToBottom();
                                }
                            } catch (e) { /* Ignore partial JSON */ }
                        }
                    }
                }

                // 3. Save Final Result
                chatHistory.push({ role: 'ai', content: fullResponseText });
                localStorage.setItem('alos_history', JSON.stringify(chatHistory));

            } catch (error) {
                if (error.name === 'AbortError') {
                    aiMessageDiv.innerHTML += ' <br><i>[Terminated by user]</i>';
                } else {
                    aiMessageDiv.innerHTML += `<br><strong>Error:</strong> ${error.message}`;
                }
            } finally {
                // Reset UI
                sendBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                abortController = null;
            }
        }

        // ==========================================
        // üõë EVENT LISTENERS
        // ==========================================
        stopBtn.addEventListener('click', () => {
            if (abortController) abortController.abort();
        });

        sendBtn.addEventListener('click', handleSend);

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });

    </script>
   </body>
</html>
